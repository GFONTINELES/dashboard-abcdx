
SELECT
        PRODUTO.DESCRCOMPRODUTO ||' '|| PRODUTO_GRADE.SUBDESCRICAO AS DESCRRESPRODUTO,
        ESTOQUE_ANALITICO.IDPRODUTO,
        ESTOQUE_ANALITICO.IDEMPRESA,
        ESTOQUE_ANALITICO.IDSUBPRODUTO,
        ESTOQUE_ANALITICO.IDOPERACAO,
        ESTOQUE_ANALITICO.IDPLANILHA,
        ESTOQUE_ANALITICO.IDCREDITOCONTABIL,
        ESTOQUE_ANALITICO.IDDEBITOCONTABIL,
        ESTOQUE_ANALITICO.IDLOCALESTOQUE,
        ESTOQUE_ANALITICO.IDVENDEDOR,
        (SELECT
                DEPARTAMENTOS.DESCRDEPARTAMENTO
        FROM
                VENDEDOR_DEPARTAMENTO_HIST AS VDH INNER JOIN DEPARTAMENTOS ON
                VDH.IDDEPARTAMENTO = DEPARTAMENTOS.IDDEPARTAMENTO
        WHERE
                VDH.IDVENDEDOR = ESTOQUE_ANALITICO.IDVENDEDOR AND
                VDH.DTCADASTRO = (SELECT
                                                MAX(VDH.DTCADASTRO) AS DT
                                        FROM
                                                VENDEDOR_DEPARTAMENTO_HIST AS VDH
                                        WHERE
                                                VDH.IDVENDEDOR = ESTOQUE_ANALITICO.IDVENDEDOR AND
                                                VDH.DTCADASTRO <= NOTAS.DTMOVIMENTO)) AS DESCRDEPARTAMENTO,
        ESTOQUE_ANALITICO.VALDESCONTOPRO,
        ESTOQUE_ANALITICO.VALFRETECONHEC,
        ESTOQUE_ANALITICO.VALICMS,
        ESTOQUE_ANALITICO.VALIPI,
        ESTOQUE_ANALITICO.VALISS,
        ESTOQUE_ANALITICO.VALICMSUBST,
        ESTOQUE_ANALITICO.VALUNITBRUTO,
        ESTOQUE_ANALITICO.VALTOTLIQUIDO,
        ESTOQUE_ANALITICO.QTDPRODUTO,
        ESTOQUE_ANALITICO.PERICM,
        ESTOQUE_ANALITICO.PERCOMISSAO,
        ESTOQUE_ANALITICO.TIPOSITTRIB,
        ESTOQUE_ANALITICO.IDSITTRIB,
        ESTOQUE_ANALITICO.VALBASESUBST,
        ESTOQUE_ANALITICO.FLAGCONFENTREGA,
        ESTOQUE_ANALITICO.FLAGCALCULOGIRO,
        ESTOQUE_ANALITICO.FLAGMOVSALDOPRO,
        ESTOQUE_ANALITICO.FLAGMOVCONTABIL,
        OPERACAO_INTERNA.DESCROPERACAO,
        ESTOQUE_CADASTRO_LOCAL.DESCRLOCAL,
        ESTOQUE_ANALITICO.FLAGMOVCUSMEDIO,
        ESTOQUE_ANALITICO.IDEMPRESABAIXAEST,
        ESTOQUE_ANALITICO.TIPOCATEGORIA,
        OPERACAO_INTERNA.TIPOITEMCATEGORIA,
        ESTOQUE_ANALITICO.PERDESCONTOFINANCEIRO,
        NOTAS.NUMNOTA,
        NOTAS.SERIENOTA,
        USUARIO.NOMEUSUARIO,
        ESTOQUE_ANALITICO.NUMSEQUENCIA,
        NOTAS.IDCLIFOR,
        CASE WHEN Date(B.DTHORAENCERRAMENTO) = Date(ESTOQUE_ANALITICO.DTMOVIMENTO) OR ESTOQUE_ANALITICO.IDOPERACAO <> 2000 THEN
            COALESCE(CAST(ESTOQUE_ANALITICO.DTMOVIMENTO || '-' || TIME(B.DTHORAENCERRAMENTO) AS TIMESTAMP), COALESCE(Cast(estoque_analitico.dtmovimento || '-'|| Time(notas.dtAlteracao) AS TIMESTAMP), ESTOQUE_ANALITICO.DTMOVIMENTO || '-23.59.59.999999') )
        ELSE
            ESTOQUE_ANALITICO.DTMOVIMENTO || '-23.59.59.000000'
        END AS DTMOVIMENTO,
        CLIENTE_FORNECEDOR.NOME,
        COALESCE(DESCRBALANCO, NOTAS_OBS_PRODUTO.OBSERVACAO) AS MOTIVO,
        NOTAS.NUMCUPOMFISCAL,
        ESTOQUE_ANALITICO.IDLOTE,
        B.FLAGZERASEMCONTAGEM,
	   COALESCE(OBS.OBSERVACAO,B.OBSERVACAO,'') as OBSERVACAOPRODUTO,
		  B.DESCRBALANCO,
	  (SELECT COALESCE(V_VARCHAR,'F') FROM CONFIG_ATRIBUTO_VALORES WHERE IDATRIBUTO = 366 FETCH FIRST 1 ROWS ONLY) AS FLAGEXIBEVALORBRUTO
FROM
        (NOTAS LEFT OUTER JOIN CLIENTE_FORNECEDOR ON (NOTAS.IDCLIFOR = CLIENTE_FORNECEDOR.IDCLIFOR)),
        (PRODUTO LEFT OUTER JOIN PRODUTO_GRADE ON (PRODUTO.IDPRODUTO = PRODUTO_GRADE.IDPRODUTO)),
        ESTOQUE_ANALITICO LEFT OUTER JOIN NOTAS_OBS_PRODUTO ON (ESTOQUE_ANALITICO.IDEMPRESA = NOTAS_OBS_PRODUTO.IDEMPRESA AND
        ESTOQUE_ANALITICO.IDPLANILHA = NOTAS_OBS_PRODUTO.IDPLANILHA AND
        ESTOQUE_ANALITICO.NUMSEQUENCIA = NOTAS_OBS_PRODUTO.NUMSEQUENCIA)
        LEFT JOIN ESTOQUE_BALANCO_ENCERRADO B ON
			(ESTOQUE_ANALITICO.IDEMPRESA = B.IDEMPRESA AND
			ESTOQUE_ANALITICO.IDPLANILHA = B.IDPLANILHA AND
			ESTOQUE_ANALITICO.IDPRODUTO = B.IDPRODUTO AND
			ESTOQUE_ANALITICO.IDSUBPRODUTO = B.IDSUBPRODUTO AND
			ESTOQUE_ANALITICO.IDLOCALESTOQUE = B.IDLOCALESTOQUE AND
			COALESCE(ESTOQUE_ANALITICO.IDLOTE,'') = COALESCE(B.IDLOTE,''))
	   LEFT JOIN DOCUMENTO_OBSERVACAO_PRODUTO_HISTORICO OBS ON
			(ESTOQUE_ANALITICO.IDEMPRESA = OBS.IDEMPRESA AND
			ESTOQUE_ANALITICO.IDPLANILHA = OBS.IDPLANILHA AND
			ESTOQUE_ANALITICO.IDPRODUTO = OBS.IDPRODUTO AND
			ESTOQUE_ANALITICO.IDSUBPRODUTO = OBS.IDSUBPRODUTO AND
			ESTOQUE_ANALITICO.NUMSEQUENCIA = OBS.NUMSEQUENCIA),
        ESTOQUE_CADASTRO_LOCAL,
        OPERACAO_INTERNA,
        USUARIO
WHERE
        (ESTOQUE_ANALITICO.IDLOCALESTOQUE = ESTOQUE_CADASTRO_LOCAL.IDLOCALESTOQUE) AND
        (ESTOQUE_ANALITICO.IDOPERACAO = OPERACAO_INTERNA.IDOPERACAO) AND
        (ESTOQUE_ANALITICO.IDPRODUTO = PRODUTO.IDPRODUTO) AND
	     (NOTAS.IDUSUARIO = USUARIO.IDUSUARIO) AND
        (NOTAS.IDEMPRESA = ESTOQUE_ANALITICO.IDEMPRESA) AND
        (ESTOQUE_ANALITICO.IDSUBPRODUTO = PRODUTO_GRADE.IDSUBPRODUTO) AND
            (NOTAS.IDPLANILHA = ESTOQUE_ANALITICO.IDPLANILHA) AND
        (ESTOQUE_ANALITICO.IDOPERACAO <> 1301) AND
                  (OPERACAO_INTERNA.TIPOITEMCATEGORIA <> 'D11') AND
         (ESTOQUE_ANALITICO.IDOPERACAO <> 3000)

    -- ðŸ”½ FILTROS ADICIONADOS (CORRETOS)
    AND ESTOQUE_ANALITICO.IDEMPRESA = {loja}
    AND DATE(ESTOQUE_ANALITICO.DTMOVIMENTO)
        BETWEEN DATE('{data_inicial}')
            AND DATE('{data_final}')

    --filtros adicionais 